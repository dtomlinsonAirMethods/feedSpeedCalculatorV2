<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feed & Speed Calculator</title>
  <link rel="stylesheet" href="styles/style.css" />
  <link rel="icon" type="image/x-icon" href="img/favicon.ico">
  <link rel="manifest" href="manifest.json">

</head>
<body>
  <header><h1>Feed & Speed Calculator</h1></header>

  <main>
    <!-- Tab navigation -->
    <div class="tabs">
      <button class="tablink active" onclick="openTab(event, 'endmillTab')">Endmill</button>
      <button class="tablink" onclick="openTab(event, 'drillTab')">Drill</button>
      <button class="tablink" onclick="openTab(event, 'tappingTab')">Tapping</button>
    </div>

    <!-- -------- Endmill Tab -------- -->
    <section id="endmillTab" class="tabcontent" style="display:block;">
    <div class="radio-row">
      <label class="main">Tool Type</label>
      <div class="radio-group-inline">
        <label><input type="radio" name="toolType" value="Flat Endmill" checked> Flat</label>
        <label><input type="radio" name="toolType" value="Bull Nose"> Bull</label>
        <label><input type="radio" name="toolType" value="Ball Nose"> Ball</label>
      </div>
    </div>

      <label>Diameter (in)</label>
      <input id="dia" type="number" value="0.50" step="0.01">

      <label>Flutes</label>
      <input id="flutes" type="number" value="3">

      <label>Stickout (in)</label>
      <input id="stickout" type="number" value="1.5" step="0.01">

      <label>Stepover (%)</label>
      <input id="stepover" type="number" value="25">

      <label>Depth of Cut (in)</label>
      <input id="depth" type="number" value="0.5" step="0.01">

      <label>Corner Radius (in)</label>
      <input id="cornerRadius" type="number" value="0" step="0.001">

      <label>Material</label>
      <select id="material">
        <option>7075 Aluminum</option>
        <option>6061 Aluminum</option>
        <option>Stainless Steel</option>
        <option>HRS Steel</option>
      </select>

    <div class="checkbox-field">
      <label>High Speed Machining (HSM)<input type="checkbox" id="hsm"></label>
    </div>

      <button onclick="calculateEndmill()">Calculate</button>

      <p id="rpm">RPM: </p>
      <p id="feedRate">Feed Rate (IPM): </p>
      <p id="sfmOut">SFM: </p>
      <p id="iptOut">Feed per Tooth (IPT): </p>
      <p id="warnings" class="warn"></p>
    </section>

    <!-- -------- Drill Tab -------- -->
    <section id="drillTab" class="tabcontent">
      <label>Diameter (in)</label>
      <input id="diaDrill" type="number" value="0.25" step="0.001">

      <label>Flutes</label>
      <input id="flutesDrill" type="number" value="2">

      <label>Material</label>
      <select id="drillMaterial">
        <option>7075 Aluminum</option>
        <option>6061 Aluminum</option>
        <option>Stainless Steel</option>
        <option>HRS Steel</option>
      </select>

      <label>Drill Type</label>
      <select id="drillType">
        <option>Drill</option>
        <option>Spotter</option>
        <option>Center Drill</option>
        <option>Reamer</option>
      </select>

      <label>Stickout (in)</label>
      <input id="stickoutDrill" type="number" value="1.0" step="0.01">

      <label>Depth (in)</label>
      <input id="depthDrill" type="number" value="1.0" step="0.01">

      <label><input type="checkbox" id="pecking"> Pecking</label>

      <button onclick="calculateDrill()">Calculate</button>

      <p id="rpmDrill">RPM: </p>
      <p id="feedDrill">Feed Rate (IPM): </p>
      <p id="peckOut"></p>
      <p id="drillWarn" class="warn"></p>
    </section>

    <!-- -------- Tapping Tab -------- -->
    <section id="tappingTab" class="tabcontent">
      <label>Thread Type</label>
      <select id="threadType" onchange="updateThreadSizes();updateThreadClasses();">
        <option>UNC</option>
        <option>UNF</option>
        <option>UNEF</option>
        <option>UNJ</option>
        <option>ISO</option>
      </select>

      <label>Thread Size</label>
      <select id="threadSize"></select>

      <label>Thread Class</label>
      <select id="threadClass"></select>

      <label>Thread Depth (in)</label>
      <input id="threadDepth" type="number" step="0.01" />

      <label>Hole Type</label>
      <select id="holeType">
        <option>Through</option>
        <option>Blind</option>
      </select>

      <label>Tap Type</label>
      <select id="tapType">
        <option>Cut Tap</option>
        <option>Form Tap</option>
      </select>

      <label>Material</label>
      <select id="threadMaterial">
        <option>7075 Aluminum</option>
        <option>6061 Aluminum</option>
        <option>Stainless Steel</option>
        <option>HRS Steel</option>
      </select>

      <button onclick="calculateThreading()">Calculate</button>

      <h3>Results</h3>
      <p id="rpmThread">RPM: </p>
      <p id="feedThread">Feed Rate (IPM): </p>
      <p id="threadPeck">Suggested Peck: </p>

      <!-- üîπ Added output block for geometry -->
      <div id="threadGeometry" style="margin-top: 1em; border-top: 1px solid #ccc; padding-top: 0.5em;">
        <h4>Thread Geometry</h4>
        <p id="threadMajorDia"></p>
        <p id="threadMinorDia"></p>
        <p id="threadPitchDia"></p>
        <p id="threadAllowance"></p>
      </div>
    </section>

    <!-- Custom install banner -->
    <div id="installBanner" class="install-banner hidden">
      <p>Install <strong>Feed & Speed Calculator</strong> for quick access.</p>
      <div class="banner-buttons">
        <button id="installBtn">Install</button>
        <button id="dismissBtn">Dismiss</button>
      </div>
    </div>
  </main>

<!-- JSON loading and script injection -->
<script>
  Promise.all([
    fetch("data/material.json").then(r => r.json()),
    fetch("data/thread.json").then(r => r.json()),
    fetch("data/ipt.json").then(r => r.json())
  ])
    .then(([materials, threads, ipt]) => {
      window.materialsData = materials;
      window.threadsData = threads;
      window.iptData = ipt;
      console.log("‚úÖ JSON data loaded:", { materials, threads, ipt });
    })
    .catch(err => {
      console.error("‚ö† Failed to load JSON data:", err);
      alert("Error loading data files. Check console for details.");
    })
    .finally(() => {
      const script = document.createElement("script");
      script.src = "js/script.js";
      document.body.appendChild(script);
    });
</script>

<!-- Register Service Worker & Handle Install Prompt -->
<script>
  // --- Register Service Worker ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("js/service-worker.js")
        .then((reg) => console.log("‚úÖ Service Worker registered:", reg.scope))
        .catch((err) => console.error("‚ö† Service Worker registration failed:", err));
    });
  }

  // --- Setup Install Prompt Handling ---
  let deferredPrompt;
  const installBanner = document.getElementById("installBanner");
  const installBtn = document.getElementById("installBtn");
  const dismissBtn = document.getElementById("dismissBtn");

  console.log("üß† Waiting for beforeinstallprompt event...");

  // Listen for install prompt event
  window.addEventListener("beforeinstallprompt", (e) => {
    console.log("üì± beforeinstallprompt triggered!", e);

    // Stop the default mini-infobar
    e.preventDefault();
    deferredPrompt = e;
    console.log("üì≤ App install prompt captured!");

    const dismissed = localStorage.getItem("pwaDismissedUntil");
    const isInstalled = window.matchMedia("(display-mode: standalone)").matches;

    if (!isInstalled && (!dismissed || Date.now() > parseInt(dismissed))) {
      setTimeout(() => {
        console.log("ü™Ñ Showing install banner");
        installBanner.classList.remove("hidden");
        installBanner.classList.add("show");
      }, 1500);
    } else {
      console.log("‚öôÔ∏è App already installed or banner recently dismissed");
    }
  });

  // --- Install button click ---
  installBtn.addEventListener("click", async () => {
    console.log("üñ± Install button clicked");
    if (!deferredPrompt) {
      console.warn("‚ö†Ô∏è No deferredPrompt available yet");
      return;
    }

    installBanner.classList.remove("show");
    installBanner.classList.add("hidden");

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`üì≤ User install choice: ${outcome}`);
    deferredPrompt = null;
  });

  // --- Dismiss button click ---
  dismissBtn.addEventListener("click", () => {
    installBanner.classList.remove("show");
    installBanner.classList.add("hidden");
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    localStorage.setItem("pwaDismissedUntil", Date.now() + sevenDays);
    console.log("üö´ Install banner dismissed for 7 days");
  });

  // --- App installed event ---
  window.addEventListener("appinstalled", () => {
    console.log("‚úÖ App installed successfully!");
    localStorage.removeItem("pwaDismissedUntil");
    installBanner.classList.remove("show");
    installBanner.classList.add("hidden");
  });

  // --- Debug helper ---
  function pwaDebug() {
    console.log("üîç PWA Installability Check:");
    console.log("Manifest linked:", !!document.querySelector('link[rel="manifest"]'));
    console.log("HTTPS or localhost:", window.isSecureContext);
    console.log("Service Worker active:", !!navigator.serviceWorker.controller);
    console.log("Standalone mode:", window.matchMedia("(display-mode: standalone)").matches);
    console.log("Deferred prompt captured:", !!deferredPrompt);
  }

  window.pwaDebug = pwaDebug;
</script>

</body>
</html>